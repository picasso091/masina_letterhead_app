<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Masina Notice Generator</title>

    <!-- Material Symbols calendar icon -->
    <link
      rel="stylesheet"
      href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200&icon_names=calendar_month"
    />
    <style>
      .material-symbols-outlined {
        font-variation-settings:
          "FILL" 0,
          "wght" 400,
          "GRAD" 0,
          "opsz" 24;
        vertical-align: middle;
      }

      body {
        font-family: Arial;
        padding: 40px;
        background: #f4f4f4;
      }
      form {
        background: white;
        padding: 26px;
        max-width: 920px;
        margin: auto;
        border-radius: 12px;
        box-shadow: 0 0 12px rgba(0, 0, 0, 0.08);
      }

      input,
      textarea,
      select {
        width: 100%;
        padding: 10px 14px;
        margin: 8px 0 16px;
        border-radius: 8px;
        border: 1px solid #cfcfcf;
        box-sizing: border-box;
        font-size: 16px;
        background: #fff;
      }
      textarea {
        resize: vertical;
      }
      button {
        padding: 12px 18px;
        background: #235eff;
        color: white;
        border: none;
        cursor: pointer;
        font-size: 16px;
        border-radius: 10px;
      }
      button:hover {
        background: #24308a;
      }
      label {
        font-weight: 700;
        display: block;
        margin-top: 6px;
        font-size: 14px;
      }
      .row {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 18px;
      }
      .hint {
        font-size: 13px;
        color: #666;
        margin-top: -10px;
        margin-bottom: 12px;
      }
      .hidden {
        display: none;
      }

      /* Date wrapper + consistent icon */
      .date-wrapper {
        position: relative;
        width: 100%;
        cursor: pointer;
      }
      .date-wrapper input {
        height: 48px;
        padding: 0 52px 0 14px;
        line-height: 48px;
        cursor: pointer;
      }

      /* Hide native AD icon but keep native picker working */
      input[type="date"]::-webkit-calendar-picker-indicator {
        opacity: 0;
        position: absolute;
        right: 0;
        width: 100%;
        height: 100%;
        cursor: pointer;
      }

      .calendar-icon {
        position: absolute;
        right: 12px;
        top: 50%;
        /* Optical correction for Material font glyph box */
        transform: translateY(calc(-50% + 1px));
        font-size: 24px;
        line-height: 1;
        color: #666;
        pointer-events: auto; /* clickable */
        cursor: pointer;
        user-select: none;
      }

      /* Make hover feel consistent */
      .date-wrapper:hover .calendar-icon {
        color: #444;
      }
    </style>

    <!-- Nepali Date Picker CSS (local from node_modules/dist) -->
    <link
      rel="stylesheet"
      href="/vendor/nepali-date-picker/nepali.datepicker.v{{NDP_VERSION}}.min.css"
    />
  </head>

  <body>
    <h2 id="pageTitle">Masina Digitech Notice Generator</h2>

    <form action="/generate" method="POST" id="noticeForm">
      <div class="row">
        <div>
          <label id="labelLanguage">Language</label>
          <select name="language" id="languageSelect" required>
            <option value="english" id="optLangEnglish">English</option>
            <option value="nepali" id="optLangNepali">Nepali</option>
          </select>
        </div>

        <div>
          <label id="labelDateType">Date Type</label>
          <select name="dateType" id="dateTypeSelect" required>
            <option value="ad" id="optDateTypeAD">English (AD)</option>
            <option value="bs" id="optDateTypeBS">Nepali (BS)</option>
          </select>
        </div>
      </div>

      <!-- AD Date Picker -->
      <div id="adPickerWrap">
        <label id="labelDateAD">Date (AD)</label>
        <div class="date-wrapper" id="adWrapper">
          <input type="date" id="adDate" value="{{TODAY_AD_INPUT}}" />
          <span class="calendar-icon material-symbols-outlined" id="adIcon"
            >calendar_month</span
          >
        </div>
      </div>

      <!-- BS Date Picker -->
      <div id="bsPickerWrap" class="hidden">
        <label id="labelDateBS">Date (BS)</label>
        <div class="date-wrapper" id="bsWrapper">
          <input type="text" id="bsDate" readonly placeholder="YYYY/MM/DD" />
          <span class="calendar-icon material-symbols-outlined" id="bsIcon"
            >calendar_month</span
          >
        </div>
        <!-- <div class="hint" id="hintBs">Click the field or the icon to open Nepali calendar.</div> -->
      </div>

      <!-- Server reads this -->
      <input type="hidden" name="date" id="finalDate" value="" />

      <label id="labelRecipient">Recipient</label>
      <input type="text" name="recipient" id="recipientInput" required />

      <label id="labelOrganization">Organization</label>
      <input type="text" name="org" id="orgInput" required />

      <label id="labelAddress">Address</label>
      <input type="text" name="address" id="addressInput" required />

      <label id="labelSubject">Subject</label>
      <input type="text" name="subject" id="subjectInput" required />

      <label id="labelBody">Body</label>
      <textarea name="body" id="bodyInput" rows="10" required></textarea>

      <label id="labelSignName">Sign Name</label>
      <input type="text" name="signname" id="signNameInput" required />

      <label id="labelSignTitle">Sign Title</label>
      <input type="text" name="signtitle" id="signTitleInput" required />

      <button type="submit" id="btnGenerate">Generate PDF</button>
    </form>

    <!-- Nepali Date Picker JS (local from node_modules/dist) -->
    <script src="/vendor/nepali-date-picker/nepali.datepicker.v{{NDP_VERSION}}.min.js"></script>

    <script>
      const languageSelect = document.getElementById("languageSelect");
      const dateTypeSelect = document.getElementById("dateTypeSelect");
      const adWrap = document.getElementById("adPickerWrap");
      const bsWrap = document.getElementById("bsPickerWrap");

      const adDate = document.getElementById("adDate");
      const bsDate = document.getElementById("bsDate");
      const finalDate = document.getElementById("finalDate");

      const adIcon = document.getElementById("adIcon");
      const bsIcon = document.getElementById("bsIcon");

      const pad2 = (n) => String(n).padStart(2, "0");

      // ===== Translations =====
      const T = {
        english: {
          pageTitle: "Masina Digitech Letterhead Generator",
          language: "Language",
          dateType: "Date Type",
          dateAD: "Date (AD)",
          dateBS: "Date (BS)",
          recipient: "Recipient",
          organization: "Organization",
          address: "Address",
          subject: "Subject",
          body: "Body",
          signName: "Sign Name",
          signTitle: "Designation",
          // autoSwitch: "Auto-switches based on Language.",
          // bsHint: "Click the field or the icon to open Nepali calendar.",
          btn: "Generate PDF",
          optLangEnglish: "English",
          optLangNepali: "Nepali",
          optDateTypeAD: "English (AD)",
          optDateTypeBS: "Nepali (BS)",
        },
        nepali: {
          pageTitle: "Masina Digitech Letterhead Generator",
          language: "भाषा",
          dateType: "मिति प्रकार",
          dateAD: "मिति (इ.स.)",
          dateBS: "मिति (वि.स.)",
          recipient: "प्राप्तकर्ता",
          organization: "संस्था",
          address: "ठेगाना",
          subject: "विषय",
          body: "व्यहोरा",
          signName: "हस्ताक्षर नाम",
          signTitle: "पद",
          // autoSwitch: "भाषाअनुसार स्वतः परिवर्तन हुन्छ।",
          // bsHint: "मिति छान्न फिल्ड वा आइकन क्लिक गर्नुहोस्।",
          btn: "PDF बनाउनुहोस्",
          optLangEnglish: "अंग्रेजी",
          optLangNepali: "नेपाली",
          optDateTypeAD: "इ.स. (AD)",
          optDateTypeBS: "वि.स. (BS)",
        },
      };

      function toNepaliDigits(str) {
        const map = {
          0: "०",
          1: "१",
          2: "२",
          3: "३",
          4: "४",
          5: "५",
          6: "६",
          7: "७",
          8: "८",
          9: "९",
        };
        return String(str).replace(/[0-9]/g, (d) => map[d]);
      }

      function setText(id, text) {
        const el = document.getElementById(id);
        if (el) el.textContent = text;
      }

      function updateLabels(lang) {
        const t = T[lang];

        setText("pageTitle", t.pageTitle);
        setText("labelLanguage", t.language);
        setText("labelDateType", t.dateType);
        setText("labelDateAD", t.dateAD);
        setText("labelDateBS", t.dateBS);
        setText("labelRecipient", t.recipient);
        setText("labelOrganization", t.organization);
        setText("labelAddress", t.address);
        setText("labelSubject", t.subject);
        setText("labelBody", t.body);
        setText("labelSignName", t.signName);
        setText("labelSignTitle", t.signTitle);
        // setText("hintAutoSwitch", t.autoSwitch);
        // setText("hintBs", t.bsHint);
        setText("btnGenerate", t.btn);

        setText("optLangEnglish", t.optLangEnglish);
        setText("optLangNepali", t.optLangNepali);
        setText("optDateTypeAD", t.optDateTypeAD);
        setText("optDateTypeBS", t.optDateTypeBS);
      }

      // ===== Date helpers =====
      function adInputToPdf(adValue) {
        // yyyy-mm-dd -> yyyy/mm/dd
        const [y, m, d] = adValue.split("-");
        return `${y}/${m}/${d}`;
      }

      function setFinalAD() {
        finalDate.value = adDate.value ? adInputToPdf(adDate.value) : "";
      }

      function setFinalBS() {
        const val = bsDate.value || "";
        if (!val) {
          finalDate.value = "";
          return;
        }

        // If Nepali language selected, convert digits to Nepali numerals
        if (languageSelect.value === "nepali") {
          finalDate.value = toNepaliDigits(val);
        } else {
          finalDate.value = val;
        }
      }

      // ===== Nepali picker init =====
      let bsPickerInited = false;
      function initBsPicker() {
        if (bsPickerInited) return;

        if (typeof bsDate.NepaliDatePicker !== "function") {
          console.error("NepaliDatePicker not found. Check JS load.");
          return;
        }

        bsDate.NepaliDatePicker({
          dateFormat: "YYYY/MM/DD",
          closeOnDateSelect: true,
        });

        // Default to today's BS using NepaliFunctions.AD2BS
        const now = new Date();
        if (
          window.NepaliFunctions &&
          typeof window.NepaliFunctions.AD2BS === "function"
        ) {
          const bs = window.NepaliFunctions.AD2BS({
            year: now.getFullYear(),
            month: now.getMonth() + 1,
            day: now.getDate(),
          });
          bsDate.value = `${bs.year}/${pad2(bs.month)}/${pad2(bs.day)}`;
        }

        setFinalBS();
        bsPickerInited = true;
      }

      // ===== UI toggles =====
      function showAD() {
        adWrap.classList.remove("hidden");
        bsWrap.classList.add("hidden");
        setFinalAD();
      }

      function showBS() {
        bsWrap.classList.remove("hidden");
        adWrap.classList.add("hidden");
        // init after showing
        setTimeout(() => {
          initBsPicker();
          setFinalBS();
        }, 0);
      }

      function syncFromLanguage() {
        if (languageSelect.value === "english") {
          dateTypeSelect.value = "ad";
          showAD();
        } else {
          dateTypeSelect.value = "bs";
          showBS();
        }

        updateLabels(languageSelect.value);
        if (dateTypeSelect.value === "bs") setFinalBS();
        else setFinalAD();
      }

      // ===== Icon click behavior =====
      function hookIconClicks() {
        adIcon.addEventListener("click", () => {
          adDate.focus();
          adDate.click();
        });
        bsIcon.addEventListener("click", () => {
          bsDate.focus();
          bsDate.click();
        });
      }

      // ===== Listeners =====
      languageSelect.addEventListener("change", syncFromLanguage);

      dateTypeSelect.addEventListener("change", () => {
        if (dateTypeSelect.value === "ad") showAD();
        else showBS();
      });

      adDate.addEventListener("change", setFinalAD);
      bsDate.addEventListener("change", setFinalBS);
      bsDate.addEventListener("blur", setFinalBS);

      document.getElementById("noticeForm").addEventListener("submit", (e) => {
        if (dateTypeSelect.value === "ad") setFinalAD();
        else setFinalBS();

        if (!finalDate.value) {
          e.preventDefault();
          alert(
            languageSelect.value === "nepali"
              ? "कृपया मिति छान्नुहोस्।"
              : "Please select a date.",
          );
        }
      });

      window.onload = function () {
        hookIconClicks();
        // Default language: English (change to 'nepali' if you want)
        languageSelect.value = "english";
        syncFromLanguage();
      };
    </script>
  </body>
</html>
