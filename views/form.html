<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Masina Notice Generator</title>

    <style>
      body {
        font-family: Arial;
        padding: 40px;
        background: #f4f4f4;
      }
      form {
        background: white;
        padding: 26px;
        max-width: 820px;
        margin: auto;
        border-radius: 10px;
        box-shadow: 0 0 12px rgba(0, 0, 0, 0.1);
      }
      input,
      textarea,
      select {
        width: 100%;
        padding: 10px;
        margin: 8px 0 16px;
        border-radius: 6px;
        border: 1px solid #ccc;
        box-sizing: border-box;
        font-size: 14px;
      }
      textarea {
        resize: vertical;
      }
      button {
        padding: 12px 18px;
        background: #24308a;
        color: white;
        border: none;
        cursor: pointer;
        font-size: 16px;
        border-radius: 8px;
      }
      button:hover {
        background: #e00000;
      }
      label {
        font-weight: 600;
        display: block;
        margin-top: 6px;
      }
      .row {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 16px;
      }
      .hint {
        font-size: 12px;
        color: #666;
        margin-top: -10px;
        margin-bottom: 12px;
      }
      .hidden {
        display: none;
      }
      .date-field {
        position: relative;
      }

      .date-field input {
        padding-right: 44px; /* space for icon */
      }

      .calendar-btn {
        position: absolute;
        right: 10px;
        top: 50%;
        transform: translateY(-50%);
        width: 34px;
        height: 34px;
        border: 1px solid #ccc;
        border-radius: 8px;
        background: #fff;
        cursor: pointer;
        display: grid;
        place-items: center;
      }

      .calendar-btn:hover {
        border-color: #999;
      }

      .calendar-btn svg {
        width: 18px;
        height: 18px;
      }
      /* Make BS input visually identical to native date input */

      .bs-date-input {
        background-image: url("data:image/svg+xml;utf8,\<svg xmlns='http://www.w3.org/2000/svg' fill='none' stroke='%23666' stroke-width='2' viewBox='0 0 24 24'>\<rect x='3' y='4' width='18' height='18' rx='2' ry='2'></rect>\<line x1='16' y1='2' x2='16' y2='6'></line>\<line x1='8' y1='2' x2='8' y2='6'></line>\<line x1='3' y1='10' x2='21' y2='10'></line>\</svg>");
        background-repeat: no-repeat;
        background-position: right 12px center;
        background-size: 18px;
        padding-right: 40px; /* space for icon */
        cursor: pointer;
      }
      /* Wrapper */
.date-wrapper {
  position: relative;
}

/* Inputs */
.date-wrapper input {
  width: 100%;
  padding-right: 44px;
}

/* Remove native Chrome calendar icon */
input[type="date"]::-webkit-calendar-picker-indicator {
  opacity: 0;
  position: absolute;
  right: 0;
  width: 100%;
  cursor: pointer;
}

/* Custom Material Icon */
.calendar-icon {
  position: absolute;
  right: 12px;
  top: 50%;
  transform: translateY(-50%);
  color: #666;
  pointer-events: none;
  font-size: 22px;
}
/* Make BS input behave like clickable date picker */
#bsDate {
  cursor: pointer;
}

/* Also change cursor when hovering icon */
.date-wrapper .calendar-icon {
  cursor: pointer;
}

/* Optional: change entire wrapper hover */
.date-wrapper:hover input {
  cursor: pointer;
}
.date-wrapper {
  position: relative;
  cursor: pointer;
}

.date-wrapper input {
  width: 100%;
  padding-right: 44px;
  cursor: pointer;
}

.calendar-icon {
  position: absolute;
  right: 12px;
  top: 50%;
  transform: translateY(-50%);
  color: #666;
  font-size: 22px;
  pointer-events: auto;
  cursor: pointer;
}
/* wrapper stays same */
.date-wrapper { position: relative; width: 100%; }

/* inputs same height */
.date-wrapper input{
  width:100%;
  height:48px;
  padding:0 44px 0 14px;
  box-sizing:border-box;
  font-size:16px;
  line-height:48px;
}

/* hide native AD icon */
input[type="date"]::-webkit-calendar-picker-indicator{
  opacity:0;
  position:absolute;
  right:0;
  width:100%;
  cursor:pointer;
}

/* ✅ Material icon true centering */
.calendar-icon{
  position:absolute;
  right:12px;
  top:50%;
  transform:translateY(-50%);
  font-size:24px;
  line-height:1;          /* IMPORTANT: remove font baseline extra */
  display:block;
  color:#666;
  pointer-events:none;
}

/* ✅ tiny optical correction (tune if needed) */
.calendar-icon{
  transform: translateY(calc(-50% + 1px));
}
.material-symbols-outlined{
  vertical-align: middle;
}
    </style>

    <!-- ✅ Nepali Date Picker CSS (local from node_modules dist, README path) -->
    <link
      rel="stylesheet"
      href="/vendor/nepali-date-picker/nepali.datepicker.v5.0.6.min.css"
    />
  </head>
  <link rel="stylesheet"
  href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200&icon_names=calendar_month" />

<style>
.material-symbols-outlined {
  font-variation-settings:
    'FILL' 0,
    'wght' 400,
    'GRAD' 0,
    'opsz' 24;
}
</style>

  <body>
    <h2>Masina Digitech Notice Generator</h2>

    <form action="/generate" method="POST" id="noticeForm">
      <div class="row">
        <div>
          <label>Language</label>
          <select name="language" id="languageSelect" required>
            <option value="nepali">Nepali</option>
            <option value="english">English</option>
          </select>
        </div>

        <div>
          <label>Date Type</label>
          <select name="dateType" id="dateTypeSelect" required>
            <option value="bs">Nepali (BS)</option>
            <option value="ad">English (AD)</option>
          </select>
        </div>
      </div>

      <!-- AD Date Picker -->
      <div id="adPickerWrap">
  <label>Date (AD)</label>

  <div class="date-wrapper">
    <input type="date" id="adDate" value="{{TODAY_AD_INPUT}}" />
    <span class="calendar-icon material-symbols-outlined">
      calendar_month
    </span>
  </div>
</div>

      <!-- BS Date Picker -->
     <div id="bsPickerWrap" class="hidden">
  <label>Date (BS)</label>

  <div class="date-wrapper">
    <input type="text" id="bsDate" readonly />
    <span class="calendar-icon material-symbols-outlined">
      calendar_month
    </span>
  </div>

</div>

      <!-- ✅ Server reads this -->
      <input type="hidden" name="date" id="finalDate" value="" />

      <label>Recipient</label>
      <input type="text" name="recipient" required />

      <label>Organization</label>
      <input type="text" name="org" required />

      <label>Address</label>
      <input type="text" name="address" required />

      <label>Subject</label>
      <input type="text" name="subject" required />

      <label>Body</label>
      <textarea name="body" rows="10" required></textarea>

      <label>Sign Name</label>
      <input type="text" name="signname" required />

      <label>Sign Title</label>
      <input type="text" name="signtitle" required />

      <button type="submit">Generate PDF</button>
    </form>

    <!-- ✅ Nepali Date Picker JS (local from node_modules dist, README path) -->
    <script
      src="/vendor/nepali-date-picker/v5/nepali.datepicker/js/nepali.datepicker.v{{NDP_VERSION}}.min.js"
      type="text/javascript"
    ></script>

    <script>
      const languageSelect = document.getElementById("languageSelect");
      const dateTypeSelect = document.getElementById("dateTypeSelect");

      const adWrap = document.getElementById("adPickerWrap");
      const bsWrap = document.getElementById("bsPickerWrap");

      const adDate = document.getElementById("adDate");
      const bsDate = document.getElementById("bsDate");
      const finalDate = document.getElementById("finalDate");

      const bsCalendarBtn = document.getElementById("bsCalendarBtn");

      // Open picker when icon clicked
      if (bsCalendarBtn) {
        bsCalendarBtn.addEventListener("click", () => {
          bsDate.focus(); // picker opens on focus
          bsDate.click(); // some builds open on click
        });
      }

      const pad2 = (n) => String(n).padStart(2, "0");

      function adInputToPdf(adValue) {
        const [y, m, d] = adValue.split("-");
        return `${y}/${m}/${d}`;
      }

      function setFinalAD() {
        finalDate.value = adDate.value ? adInputToPdf(adDate.value) : "";
      }

      function setFinalBS() {
        finalDate.value = bsDate.value || "";
      }

      let bsPickerInited = false;

      function initBsPicker() {
        if (bsPickerInited) return;

        if (typeof bsDate.NepaliDatePicker !== "function") {
          console.error("NepaliDatePicker function not found. JS not loaded.");
          return;
        }

        // Initialize picker
        bsDate.NepaliDatePicker({
          dateFormat: "YYYY/MM/DD",
          closeOnDateSelect: true,
          onSelect: function () {
            // bsDate.value will be filled by picker
            document.getElementById("finalDate").value = bsDate.value;
          },
        });

        // Set default BS = today's BS
        const now = new Date();
        if (window.NepaliFunctions && window.NepaliFunctions.AD2BS) {
          const bs = window.NepaliFunctions.AD2BS({
            year: now.getFullYear(),
            month: now.getMonth() + 1,
            day: now.getDate(),
          });
          bsDate.value = `${bs.year}/${String(bs.month).padStart(2, "0")}/${String(bs.day).padStart(2, "0")}`;
          document.getElementById("finalDate").value = bsDate.value;
        }

        bsPickerInited = true;
      }
      function showAD() {
        adWrap.classList.remove("hidden");
        bsWrap.classList.add("hidden");
        setFinalAD();
      }

      function showBS() {
        bsWrap.classList.remove("hidden");
        adWrap.classList.add("hidden");

        // Ensure init happens after it becomes visible
        setTimeout(() => {
          initBsPicker();
          setFinalBS();
        }, 0);
      }

      function syncFromLanguage() {
        if (languageSelect.value === "english") {
          dateTypeSelect.value = "ad";
          showAD();
        } else {
          dateTypeSelect.value = "bs";
          showBS();
        }
      }

      // Events
      languageSelect.addEventListener("change", syncFromLanguage);

      dateTypeSelect.addEventListener("change", () => {
        if (dateTypeSelect.value === "ad") showAD();
        else showBS();
      });

      adDate.addEventListener("change", setFinalAD);
      bsDate.addEventListener("change", setFinalBS);
      bsDate.addEventListener("blur", setFinalBS);

      document.getElementById("noticeForm").addEventListener("submit", (e) => {
        if (dateTypeSelect.value === "ad") setFinalAD();
        else setFinalBS();

        if (!finalDate.value) {
          e.preventDefault();
          alert("Please select a date.");
        }
      });

      // Default: Nepali mode (BS)
      window.onload = function () {
        syncFromLanguage();
      };
    </script>
    <script src="/vendor/nepali-date-picker/nepali.datepicker.v5.0.6.min.js"></script>
  </body>
</html>
